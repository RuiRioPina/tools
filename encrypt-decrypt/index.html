<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Encrypt / Decrypt Message</title>
  <style>
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --border: #334155;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --danger: #ef4444;
      --success: #22c55e;
      --radius: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .container { max-width: 600px; margin: 0 auto; }

    h1 { font-size: 1.75rem; margin-bottom: 0.25rem; }
    .subtitle { color: var(--muted); margin-bottom: 1.5rem; font-size: 0.9rem; }

    .tabs {
      display: flex; gap: 0; margin-bottom: 0;
    }
    .tab {
      flex: 1; padding: 0.75rem; text-align: center;
      background: var(--bg); border: 1px solid var(--border);
      cursor: pointer; font-weight: 500; font-size: 0.9rem;
      transition: background 0.2s;
    }
    .tab:first-child { border-radius: var(--radius) 0 0 0; }
    .tab:last-child { border-radius: 0 var(--radius) 0 0; }
    .tab.active { background: var(--surface); border-bottom-color: var(--surface); color: var(--accent); }
    .tab:not(.active):hover { background: var(--surface); }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      padding: 1.5rem;
    }

    .view { display: none; }
    .view.active { display: block; }

    label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em; }

    input[type="password"], textarea {
      width: 100%; padding: 0.7rem 0.9rem; font-size: 0.95rem;
      border: 1px solid var(--border); border-radius: 6px;
      background: var(--bg); color: var(--text);
      font-family: inherit; outline: none;
      transition: border-color 0.2s;
      margin-bottom: 1rem;
    }
    textarea { min-height: 120px; resize: vertical; font-family: inherit; }
    input:focus, textarea:focus { border-color: var(--accent); }

    button {
      padding: 0.65rem 1.5rem;
      border-radius: 6px; border: none;
      background: var(--accent); color: #fff;
      font-size: 0.9rem; font-weight: 600;
      cursor: pointer; transition: background 0.2s;
    }
    button:hover { background: var(--accent-hover); }
    button.success-btn { background: var(--success); }
    button.success-btn:hover { background: #16a34a; }

    .result {
      display: none; margin-top: 1.25rem;
      background: var(--bg); border-radius: 6px;
      padding: 1rem; word-break: break-all;
    }
    .result.show { display: block; }

    .result-label { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.4rem; text-transform: uppercase; }

    .link-box {
      background: var(--surface); padding: 0.6rem;
      border-radius: 4px; font-family: monospace;
      font-size: 0.78rem; word-break: break-all;
      margin: 0.75rem 0;
      border: 1px solid var(--border);
    }

    .decrypted-msg {
      background: var(--surface);
      border-left: 3px solid var(--accent);
      padding: 1rem; border-radius: 0 6px 6px 0;
      white-space: pre-wrap; word-break: break-word;
      font-size: 0.95rem; line-height: 1.5;
    }

    .error { color: var(--danger); font-size: 0.85rem; margin-top: 0.5rem; }
    .status { color: var(--success); font-size: 0.85rem; margin-top: 0.5rem; }

    .btn-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    .back-link { display: inline-block; margin-bottom: 1rem; color: var(--accent); text-decoration: none; font-size: 0.85rem; }
    .back-link:hover { text-decoration: underline; }

    .info-text { font-size: 0.8rem; color: var(--muted); margin-top: 1rem; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="container">
    <a href="../" class="back-link">‚Üê All Tools</a>
    <h1>üîê Encrypt / Decrypt</h1>
    <p class="subtitle">Share encrypted messages via URL. Everything runs in your browser using the Web Crypto API.</p>

    <div class="tabs">
      <div class="tab active" data-tab="encrypt">Encrypt</div>
      <div class="tab" data-tab="decrypt">Decrypt</div>
    </div>

    <div class="card">
      <div class="view active" id="encryptView">
        <label for="encPass">Passphrase</label>
        <input type="password" id="encPass" placeholder="Choose a strong passphrase" autocomplete="new-password">

        <label for="encMsg">Message</label>
        <textarea id="encMsg" placeholder="Type your secret message‚Ä¶"></textarea>

        <div class="btn-row">
          <button id="encryptBtn">Encrypt</button>
        </div>

        <div class="result" id="encResult">
          <div class="result-label">Share this link</div>
          <div class="link-box" id="shareLink"></div>
          <div class="btn-row">
            <button class="success-btn" id="copyLinkBtn">Copy Link</button>
          </div>
          <div class="status" id="copyStatus"></div>
        </div>

        <p class="info-text">The encrypted payload is stored entirely in the URL fragment (#). It never leaves your browser or touches any server.</p>
      </div>

      <div class="view" id="decryptView">
        <p id="decPrompt" style="margin-bottom:1rem; color: var(--muted); font-size: 0.9rem;">
          Open an encrypted link to see the decryption form, or paste the encrypted data below.
        </p>

        <label for="decPass">Passphrase</label>
        <input type="password" id="decPass" placeholder="Enter the passphrase" autocomplete="off">

        <div class="btn-row">
          <button id="decryptBtn">Decrypt</button>
        </div>

        <div class="error" id="decError"></div>

        <div class="result" id="decResult">
          <div class="result-label">Decrypted Message</div>
          <div class="decrypted-msg" id="decText"></div>
        </div>
      </div>
    </div>
  </div>

<script>
// Crypto helpers
async function deriveKey(passphrase, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(passphrase), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function encryptMessage(message, passphrase) {
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(passphrase, salt);
  const encoded = new TextEncoder().encode(message);
  const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoded);
  const combined = new Uint8Array(salt.length + iv.length + ciphertext.byteLength);
  combined.set(salt, 0);
  combined.set(iv, salt.length);
  combined.set(new Uint8Array(ciphertext), salt.length + iv.length);
  return btoa(String.fromCharCode(...combined));
}

async function decryptMessage(payload, passphrase) {
  const binary = atob(payload);
  const bytes = Uint8Array.from(binary, c => c.charCodeAt(0));
  const salt = bytes.slice(0, 16);
  const iv = bytes.slice(16, 28);
  const data = bytes.slice(28);
  const key = await deriveKey(passphrase, salt);
  const plaintext = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
  return new TextDecoder().decode(plaintext);
}

// UI
const tabs = document.querySelectorAll('.tab');
const views = document.querySelectorAll('.view');

tabs.forEach(tab => tab.addEventListener('click', () => {
  tabs.forEach(t => t.classList.remove('active'));
  views.forEach(v => v.classList.remove('active'));
  tab.classList.add('active');
  document.getElementById(tab.dataset.tab + 'View').classList.add('active');
}));

// Encrypt
document.getElementById('encryptBtn').addEventListener('click', async () => {
  const pass = document.getElementById('encPass').value;
  const msg = document.getElementById('encMsg').value;
  if (!pass || !msg) return;

  const encrypted = await encryptMessage(msg, pass);
  const url = `${location.origin}${location.pathname}#${encrypted}`;
  document.getElementById('shareLink').textContent = url;
  document.getElementById('encResult').classList.add('show');
  history.replaceState(null, '', `#${encrypted}`);
});

document.getElementById('copyLinkBtn').addEventListener('click', async () => {
  const link = document.getElementById('shareLink').textContent;
  await navigator.clipboard.writeText(link);
  const st = document.getElementById('copyStatus');
  st.textContent = 'Copied to clipboard!';
  setTimeout(() => st.textContent = '', 2000);
});

// Decrypt
document.getElementById('decryptBtn').addEventListener('click', async () => {
  const pass = document.getElementById('decPass').value;
  const payload = location.hash.substring(1);
  const errEl = document.getElementById('decError');
  const resEl = document.getElementById('decResult');
  errEl.textContent = '';
  resEl.classList.remove('show');

  if (!payload) { errEl.textContent = 'No encrypted data found in URL.'; return; }
  if (!pass) { errEl.textContent = 'Please enter a passphrase.'; return; }

  try {
    const text = await decryptMessage(payload, pass);
    document.getElementById('decText').textContent = text;
    resEl.classList.add('show');
  } catch {
    errEl.textContent = 'Decryption failed. Wrong passphrase?';
  }
});

// Auto-switch to decrypt if hash present
if (location.hash.length > 1) {
  tabs.forEach(t => t.classList.remove('active'));
  views.forEach(v => v.classList.remove('active'));
  document.querySelector('[data-tab="decrypt"]').classList.add('active');
  document.getElementById('decryptView').classList.add('active');
  document.getElementById('decPrompt').textContent = 'This link contains an encrypted message. Enter the passphrase to decrypt it.';
}
</script>
</body>
</html>
